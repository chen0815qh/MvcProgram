@{
    ViewBag.Title = "MessageBoard";
}
@using MODEL;
@model  List<MsgList>
<h2>我的留言板</h2>
@section head{
    <style type="text/css">
        .pageNumber {
            color: red;
            font-weight: bolder;
        }

        .pageBar {
            padding: 10px 0px;
        }

            .pageBar a {
                margin: 0px 4px;
            }

        .portrait:hover {
            opacity: 0.7;
        }

        .replyDiv {
            display: none;
            width: 80%;
        }

        .reply {
            margin-top: 5px;
        }

            .reply p {
                margin: 0px;
                line-height: 26px;
            }
    </style>
    <script src="~/Content/Js/UEditor/ueditor.config.js"></script>
    <script src="~/Content/Js/UEditor/ueditor.all.js"></script>
    <script src="~/Content/Js/UEditor/lang/zh-cn/zh-cn.js"></script>
    <script type="text/javascript">
        $(function () {
            var ue;
            $("a[replyid]").click(function () {
                $(this).parent().parent().find("div.replyDiv").show();
                var id = $(this).parent().parent().find("div.replyDiv").find("div.editor").attr("id");
                ue = UE.getEditor(id);
            });
            $("input[type=submit][replyid]").click(function () {

                var msgId = $(this).attr("replyid");
                var authorid = $(this).attr("authorid");

                var content = ue.getContent();

                jQuery.post("/Members/Reply", { msgId: msgId, memberId: authorid, content: content }, function (data, status) {
                    //注意：由于Reply返回的就是json，这里不需要使用$.parseJSON进行转换，也不要指定 dataType:"json"选项。
                    //data就是返回回来的json数据。

                });
            });
            $("input[cancelbtn]").click(function () {
                $(this).parents("div.replyDiv").hide();
            });
        });
    </script>

}
<div style="border-bottom:1px solid #6c852d"></div>
@{
    int count = 0;
    Members currentMemberInfo = Session["MemberInfo"] as Members;
    List<MsgList> messageList = Model.Where(m => m.ReplyId == 0).ToList();//找出留言记录
    if (ViewBag.MessageCount != null)
    {
        count = ViewBag.MessageCount;//表示别人给我们的留言记录的总的条数。
    }
}
@if (messageList != null && messageList.Count > 0)
{
    foreach (MsgList msg in messageList)
    {
        <div style="border-bottom:1px solid #dddddd;margin:10px 0px;padding:10px 0px;">
            <table style="width:100%;">
                <tr>
                    <td style="width:80px;vertical-align:top;" rowspan="3">
                        <a href="@Url.RouteUrl("Default",new{controller="Members" ,action="Leave" ,id=msg.AuthorId})"><img class="portrait" style="border-radius:8px;" src="~/Content/Images/@msg.Portrait" width="50" height="50" /></a>
                    </td>
                    <td style="vertical-align:top;">
                        <div style="color:Gray;float:left;"><span style="font-weight:bolder;color:Red;">@msg.MemberAccount</span> 第 @count 楼 </div>
                        <div style="float:right;"><a href="javascript:void(0);">删除</a></div>
                        <div style="clear:both;height:0px;"></div>
                    </td>
                </tr>
                <tr>
                    <td style="padding-top:10px;">@(Html.Raw(HttpUtility.HtmlDecode(msg.MsgContent)))</td>
                </tr>
                <tr>
                    <td style="color: Gray; padding-top: 40px;">
                        <div style="margin-bottom: 20px; border-bottom: 1px solid #EFEFEF; padding-bottom: 10px; ">
                            @msg.AddTime
                            <a href="javascript:void(0)" replyid="@msg.MsgId" style="margin:0px 10px;"> 回复 </a>
                        </div>
                        <div>
                            @{
        List<MsgList> replyList = Model.Where(m => m.ReplyId == msg.MsgId || (m.ReplyId == msg.MsgId && msg.AuthorId == currentMemberInfo.MemberId)).ToList().OrderBy(ml => ml.AddTime).ToList();
        foreach (MsgList m in replyList)
        {
            <div class="reply">
                <div style="display:inline-block;vertical-align:top;">
                    <img src="@Url.Content("~/Content/Images/"+m.Portrait)" style="border-radius:8px;vertical-align:top;" width="35" height="35" />
                </div>
                <div style="display:inline-block;margin-left:10px;">
                    <div>
                        @m.MemberAccount @(new MvcHtmlString(HttpUtility.HtmlDecode(m.MsgContent)))
                    </div>
                    <div>@m.AddTime</div>
                </div>
            </div>
        }
                            }
                        </div>
                        <div class="replyDiv">
                            <div class="editor" id="editor@(count)"></div>
                            <div style="margin:10px 0px;">
                                <input type="submit" value="确定" replyid="@msg.MsgId" authorid="@msg.MemberId" class="btn btn-default" />
                                <input type="submit" value="取消" cancelbtn class="btn btn-default" />
                            </div>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
        count--;//用于记录楼层。
    }

    <div class="pageBar">
        @*这里得到分页条*@
        @if (ViewBag.MessageCount != null)
        {
            int rowCount = ViewBag.MessageCount;
            int pageIndex = Convert.ToInt32(ViewContext.RouteData.Values["id"]);
            if (pageIndex <= 0)
            {
                pageIndex = 1;
            }
            int pageSize = ViewBag.PageSize;
            int pageCount = rowCount % pageSize == 0 ? rowCount / pageSize : rowCount / pageSize + 1;
            int nextPageIndex = pageIndex >= pageCount ? pageCount : pageIndex + 1;
            int previousPageIndex = pageIndex <= 1 ? 1 : pageIndex - 1;
            <span>共 @rowCount 条记录</span><span>当前第 <span class="pageNumber">@ViewContext.RouteData.Values["pageIndex"]</span> 页 共 @pageCount 页</span>

            <a href="/Members/MessageBoard/1">首页</a>
            @*生成前半段部分*@
            @Html.ActionLink("上一页", "MessageBoard", "Members", new { id = previousPageIndex }, null)


            {
                for (int i = 4; i > 0; i--)
                {
                    if (pageIndex - i > 0)
                    {
                        <a href="@Url.RouteUrl("Default",new{controller="Members",action="MessageBoard", pageIndex=pageIndex-i})">@(pageIndex - i)</a>
                    }
                }

            }

            <a href="@Url.RouteUrl("Default",new{id=pageIndex,controller="Members",action="MessageBoard"})" style="color:Red;font-size:14px;font-weight:bolder;">@(pageIndex)</a> @*当前页*@

            {
                for (int i = 1; i <= 4; i++)
                {
                    if (pageIndex + i <= pageCount)
                    {
                        <a href="@Url.RouteUrl("Default", new { controller="Members",action="MessageBoard", id = pageIndex + i })">@(pageIndex + i)</a>
                    }
                }
            }
            @Html.ActionLink("下一页", "MessageBoard", "Members", new { id = nextPageIndex }, null)
            <a href="/Members/MessageBoard/@pageCount">末页</a>
        }
    </div>
}
else
{
    <div style="color:Gray;font-size:16px;">亲，看来你的魅力还不够哦，还没有任何人给你留言,赶快把自己弄得时尚些吧!</div>
}