@{
    //ViewBag.Title = "Leave";
}
@using MODEL;
@model Members
@section head{
    <script src="~/Content/Js/UEditor/ueditor.config.js"></script>
    <script src="~/Content/Js/UEditor/ueditor.all.js"></script>
    <script src="~/Content/Js/UEditor/lang/zh-cn/zh-cn.js"></script>
    <script type="text/javascript">
        $(function () {
            var ue = UE.getEditor("editor");
        });
    </script>
}
<div>
    <img src="~/Content/Images/@Model.Portrait" width="120" height="120" />
</div>
<h4>给 <span style="color:Green;font-size:20px;">@(string.IsNullOrEmpty(Model.NickName) ? Model.MemberAccount : Model.NickName)</span> 留言：</h4>
@{
    Html.BeginForm("Leave", "Members", FormMethod.Post);
}
<div id="editor" style="margin:10px 0px;">

</div>
<div style="text-align:right;">
    <input type="submit" value="留言" class="btn btn-default" />
</div>
@{
    Html.EndForm();
}
@*把alert脚本放到页面底端执行，这样就不会再浏览器alert的瞬间，背景都是灰色的。*@
<script type="text/javascript">
    @if(ViewData["MsgTip"]!=null)
    {
    <text>
    alert("@ViewData["MsgTip"]");
    </text>
    }
</script>
@{
    List<ReplyList> replyList = ViewBag.ReplyList as List<ReplyList>;
    Members currentMemberInfo = Session["MemberInfo"] as Members;
    int rowCount = 0;
    if (ViewBag.LeaveCount != null)
    {
        rowCount = ViewBag.LeaveCount;
    }
}
@*这里读取出给对应用户留的言，以及对方的回复等。*@
<div class="pageBar">
    @*这里得到分页条*@
    @if (ViewBag.LeaveCount != null)
    {
        int id = Convert.ToInt32(ViewContext.RouteData.Values["id"]);
        //这个ViewContext.RouteData.Values["id"]表示取出url中对应到Default路由中id那个占位符处的值，也就是表示我们现在正在给谁留言。
        int pageIndex = Convert.ToInt32(Request.QueryString["pageIndex"]);

        if (pageIndex <= 0)
        {
            pageIndex = 1;
        }
        rowCount = ViewBag.LeaveCount;//表示我们给某个会员留了多少条言。
        int pageSize = ViewBag.PageSize;
        int pageCount = rowCount % pageSize == 0 ? rowCount / pageSize : rowCount / pageSize + 1;
        int nextPageIndex = pageIndex >= pageCount ? pageCount : pageIndex + 1;
        int previousPageIndex = pageIndex <= 1 ? 1 : pageIndex - 1;
    <span>共 @rowCount 条记录</span><span>当前第 <span class="pageNumber">@pageIndex</span> 页 共 @pageCount 页</span>

    <a href="@(Request.RawUrl+"?pageIndex=1")">首页</a>
    @*生成前半段部分*@
    @Html.ActionLink("上一页", "Leave", "Members", new { id = id, pageIndex = previousPageIndex }, null)

        //C#代码块。
        {
            for (int i = 4; i > 0; i--)
            {
                if (pageIndex - i > 0)
                {
    <a href="@Url.RouteUrl("Default",new{controller="Members",action="Leave", id=id, pageIndex=pageIndex-i})">@(pageIndex - i)</a>
                }
            }
        }

    <a href="@Url.RouteUrl("Default",new{id=id,pageIndex=pageIndex,controller="Members",action="Leave"})" style="color:Red;font-size:14px;font-weight:bolder;">@(pageIndex)</a> @*当前页*@

        {
            for (int i = 1; i <= 4; i++)
            {
                if (pageIndex + i <= pageCount)
                {
                    //注意，new{pageIndex=pageIndex+1}左侧的pageIndex是这个匿名类对象的属性，而右边的pageIndex是上面声明的局部变量。
                    //意思是：将上面的声明的局部变量pageIndex的值+1并赋值给匿名类对象的pageIndex属性。
    <a href="@Url.RouteUrl("Default", new { controller="Members",action="Leave", id =id,pageIndex=pageIndex+1})">@(pageIndex + i)</a>
                }
            }
        }
    @Html.ActionLink("下一页", "Leave", "Members", new { id = id, pageIndex = nextPageIndex }, null)
    <a href="/Members/Leave/@id?pageIndex=@pageCount">末页</a>
    }
</div>
<div style="border-bottom:1px solid #6c852d;margin:20px 0px;"></div>

@foreach (ReplyList reply in replyList)
{
    <div style="border-bottom:1px solid #dddddd;margin:10px 0px;padding:10px 0px;">
        <table style="width:100%;">
            <tr>
                <td style="width:80px;vertical-align:top;" rowspan="3">
                    <a href="@Url.RouteUrl("Default", new { controller = "Members", action = "Leave", id = reply.AuthorId })"><img class="portrait" style="border-radius:8px;" src="~/Content/Images/@reply.Portrait" width="50" height="50" /></a>
                </td>
                <td style="vertical-align:top;">
                    <div style="color:Gray;float:left;"><span style="font-weight:bolder;color:Red;">@reply.MemberAccount</span> 第 @rowCount 楼 </div>
                    <div style="float:right;"><a href="javascript:void(0);">删除</a></div>
                    <div style="clear:both;height:0px;"></div>
                </td>
            </tr>
            <tr>
                <td style="padding-top:10px;">@(Html.Raw(HttpUtility.HtmlDecode(reply.MsgContent)))</td>
            </tr>
            <tr>
                <td style="color: Gray; padding-top: 40px;">
                    <div style="margin-bottom: 20px; border-bottom: 1px solid #EFEFEF; padding-bottom: 10px; ">
                        @msg.AddTime
                        <a href="javascript:void(0)" replyid="@reply.MsgId" style="margin:0px 10px;"> 回复 </a>
                    </div>
                    <div>
                        @{
    List<MsgList> replys = Model.Where(m => m.ReplyId == msg.MsgId || (m.ReplyId == msg.MsgId && msg.AuthorId == currentMemberInfo.MemberId)).ToList().OrderBy(ml => ml.AddTime).ToList();
    foreach (MsgList m in replyList)
    {
        <div class="reply">
            <div style="display:inline-block;vertical-align:top;">
                <img src="@Url.Content("~/Content/Images/"+m.Portrait)" style="border-radius:8px;vertical-align:top;" width="35" height="35" />
            </div>
            <div style="display:inline-block;margin-left:10px;">
                <div>
                    @m.MemberAccount @(new MvcHtmlString(HttpUtility.HtmlDecode(m.MsgContent)))
                </div>
                <div>@m.AddTime</div>
            </div>
        </div>
    }
                        }
                    </div>
                    <div class="replyDiv">
                        <div class="editor" id="editor@(rowCount)"></div>
                        <div style="margin:10px 0px;">
                            <input type="submit" value="确定" replyid="@reply.MsgId" authorid="@reply.MemberId" class="btn btn-default" />
                            <input type="submit" value="取消" cancelbtn class="btn btn-default" />
                        </div>
                    </div>
                </td>
            </tr>
        </table>
    </div>
    rowCount--;
}


